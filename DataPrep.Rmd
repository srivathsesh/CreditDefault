---
title: "Credit Default Prediction"
author: "Sri Seshadri"
date: "9/28/2019"
output:
  pdf_document: default
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
```

# 1. Introduction

# 2. Executive Summary

# 3. Data

Table 1 shows the dictionary of the data that is available. 

```{r, warning = F, message = F}
library(tidyverse)
library(caret)
library(magrittr)
library(pander)
library(knitr)
library(kableExtra)
library(matrixStats)


#------------------------------------------------------
#               READ DATA IN
#---------------------------------------------------------

creditdata <- readRDS("credit_card_default.RData")

creditdata <- as.data.frame(creditdata) %>% as_tibble()
creditdata %<>% 
  mutate_at(c("DEFAULT","EDUCATION","MARRIAGE","SEX","data.group"),.funs = as.factor)

#-----------------------------------------------------
#              DATA DICTIONARY
#-----------------------------------------------------

Dict <- tibble(FEATURE = colnames(creditdata)[1:25],
               DESCRIPTION =
                 c("CUSTOMER ID",
                   "CREDIT LIMIT",
                   "GENDER",
                   "EDUCATION",
                   "MARITAL STATUS",
                   "AGE",
                   "REPAYMENT STATUS SEP 2005",
                   "REPAYMENT STATUS AUG 2005",
                   "REPAYMENT STATUS JUL 2005",
                   "REPAYMENT STATUS JUN 2005",
                   "REPAYMENT STATUS MAY 2005",
                   "REPAYMENT STATUS APR 2005",
                   "BILL SEP 2005",
                   "BILL AUG 2005",
                   "BILL JUL 2005",
                   "BILL JUN 2005",
                   "BILL MAY 2005",
                   "BILL APR 2005",
                   "PAYMENT SEP 2005",
                   "PAYMENT AUG 2005",
                   "PAYMENT JUL 2005",
                   "PAYMENT JUN 2005",
                   "PAYMENT MAY 2005",
                   "PAYMENT APR 2005",
                   "DEFAULTING CUSTOMER"
                  ),
               COMMENTS = 
                 c("",
                   "INCLUDES SUPPL CARDS",
                   "1 = MALE, 2 = FEMALE",
                   "1 = GRAD,2 = UNIV,3 = HIGH SCH,4 = OTHERS",
                   "1=MARRIED,2=SINGLE,3=OTHERS",
                   "YEARS",
                   "assumed SEP 2005 ; -1 = DULY PAID,1= 1 MONTH DELAY, 2 = 2 MONTH DELAY... 9 = >=9 MONTH DELAY",
                   "-1 = DULY PAID,1= 1 MONTH DELAY, 2 = 2 MONTH DELAY... 9 = >=9 MONTH DELAY",
                   "-1 = DULY PAID,1= 1 MONTH DELAY, 2 = 2 MONTH DELAY... 9 = >=9 MONTH DELAY",
                   "-1 = DULY PAID,1= 1 MONTH DELAY, 2 = 2 MONTH DELAY... 9 = >=9 MONTH DELAY",
                   "-1 = DULY PAID,1= 1 MONTH DELAY, 2 = 2 MONTH DELAY... 9 = >=9 MONTH DELAY",
                   "-1 = DULY PAID,1= 1 MONTH DELAY, 2 = 2 MONTH DELAY... 9 = >=9 MONTH DELAY",
                   "STATEMENT BALANCE",
                   "STATEMENT BALANCE",
                   "STATEMENT BALANCE",
                   "STATEMENT BALANCE",
                   "STATEMENT BALANCE",
                   "STATEMENT BALANCE",
                   "PAYMENT MADE",
                   "PAYMENT MADE",
                   "PAYMENT MADE",
                   "PAYMENT MADE",
                   "PAYMENT MADE",
                   "PAYMENT MADE",
                   "1 = DEFAULT, 0 = NON-DEFAULT"
                 )
           
       ) 

#*******************************************
#         REPORT DICTIONARY
#*******************************************

kable(Dict,format = "latex",align = "c",caption = "Data Dictionary") %>% 
  kable_styling(full_width = F,latex_options = "hold_position",font_size = 7) %>% 
  column_spec(1,border_left = T) %>% 
  column_spec(3,width = "20em",border_right = T) %>% 
  row_spec(0,bold = T) %>% 
  collapse_rows(valign = "middle")


# Get stats on the data
skimr::skim_with(numeric = list(hist = NULL),integer = list(hist = NULL))
skimr::skim_to_wide(creditdata) %>% 
  filter(type == "factor") %>% 
  select(variable,missing,complete,n,n_unique,top_counts) %>% 
  #mutate(top_counts = cell_spec(top_counts,"latex",align = "r")) %>% 
  kable(format = "latex",digits = 1,booktabs = T,caption = "categorical variables summary") %>% 
  kable_styling(latex_options = "hold_position")

skimr::skim_to_wide(creditdata) %>% 
  filter(type == "integer") %>% 
  select(variable,missing,complete,n,mean,sd,p0,p25,median,p75,p100) %>% 
  #mutate(top_counts = cell_spec(top_counts,"latex",align = "r")) %>% 
  kable(format = "latex",digits = 1,booktabs = T,caption = "numeric variables summary") %>% 
  kable_styling(latex_options = "hold_position",font_size = 7)

```

## 3.1 Data Issues

1. Unexpected categories in Education and Marriage. Data was inspected to potentially make a correction to the mislabeled values, no particular pattern for the mislabels emerged. Therefore the unexpected levles for EDUCATION and MARRIAGE would be mapped to "9-unknown"
2. There are negative bill amounts; they are assumed to be overpayment of credits incurred.
3. PAY_0 is assumed to be PAY_1
4. Repayment status has values that include -2 and 0. They are assumed to be non-delayed payments. 

```{r,eval=F}
lattice::barchart(~table(EDUCATION), creditdata, ylab = "Education", xlab = "Frequency")
lattice::bwplot(~LIMIT_BAL|EDUCATION,creditdata)
```

## 3.2 Data Splitting

The data was seperated into three groups for model training, validation and testing purposes. The number of customers in each of these groups are shown below.

```{r,eval=T}
creditdata %>% 
  mutate(data.group = ifelse(data.group == 1, "Train", ifelse(data.group == 2, "Test", "Validate"))) %>% 
  group_by(data.group) %>% 
  summarise(datapoints = n()) %>% knitr::kable(caption = "Train,Validation and Test splits",format = "latex",booktabs = T) %>%   kable_styling(latex_options = c("striped","hold_position"))


```



```{r, eval = F}
# # Bill amount -ve ? 
# creditdata %>% 
#   select(matches("BILL_|PAY_|DEF")) %>% 
#   #filter(BILL_AMT1 < 0 ) %>% 
#   filter_at(vars(matches('PAY_[0-9]')),any_vars(.==1)) %>% View()


# creditdata %>% 
#   mutate(BILLs = rowSums2(select(.,matches("BILL_AMT[2-6]")) %>% as.matrix()),
#          Paid = rowSums2(select(.,matches("PAY_AMT[1-5]")) %>% as.matrix())) %>% 
#   mutate(PaidFully = ifelse(BILLs - Paid ==0, 1, 0)) %>% 
#   select(ID,PaidFully) %>% 
#   filter(PaidFully == 1)

```
# 4. Feature Engineering



```{r,eval=T}
EngFeats <- data.frame(
  Feature = c(
    "Payment to Bill ratio",
    "Average Payment to Bill ratio",
    "Proportion of credit used in the month",
    " Month's in/decrease in credit use",
    "Average proportion of credit used",
    "Average Montly bill",
    "Month's in/decrease in bill",
    "Average amount paid",
    "Month's in/decrease in payment",
    "Balance growth over 6 months",
    "Credit utilization growth 6 months",
    "Month's in/decrease in Payment ratio",
    "Customer with increased utilization over time",
    "Customer with increased bill over time",
    "Customer with reduced payments time",
    "Customer with reduced payment/bill over time",
    "Max bill",
    "Max payment",
    "Max delinquency",
    "Age of customers between mentioned range"
    # "Ppk - Dist to credit limit in units of 3 std.dev of Bill",
    #"Ppk discretized with WOE values"
    
    
  ),
  `Example Column` = c(
    "$PMT\\_RATIO2$",
    # "$PMT\\_RATIO3$",
    # "$PMT\\_RATIO4$",
    # "$PMT\\_RATIO5$",
    # "$PMT\\_RATIO6$",
    
    "$Avg\\_PMT\\_RATIO$",
    
    "$UTIL\\_1$",
    # "$UTIL\\_2$",
    # "$UTIL\\_3$",
    # "$UTIL\\_4$",
    # "$UTIL\\_5$",
    # "$UTIL\\_6$",
    
    "$UTILMR5$",
    # "$UTILMR4$",
    # "$UTILMR3$",
    # "$UTILMR2$",
    # "$UTILMR1$",
  
   
    "$Avg\\_UTIL$",
    
    "$Avg\\_BILL\\_Amt$",
    
     "$BILLAMTMR5$", 
     # "$BILLAMTMR4$",
     # "$BILLAMTMR3$",
     # "$BILLAMTMR2$",
     # "$BILLAMTMR1$",
    
     "$Avg\\_PMT\\_Amt$",
    
      "$PAYMR5$",
      # "$PAYMR4$",
      # "$PAYMR3$",
      # "$PAYMR2$",
      # "$PAYMR1$",
    
    "$Bal\\_Growth\\_6mo$", 
    
    "$UTIL\\_Growth\\_6mo$", 
    
         "$PMT\\_RATIOMR5$", 
         # "$PMT\\_RATIOMR4$",
         # "$PMT\\_RATIOMR3$", 
         # "$PMT\\_RATIOMR2$", 
    
    "$UtilFlag$",
    
    '$balFlag$',
    
    "$payFlag$",
    
    
    "$payRatioFlag$",
    
    "$Max\\_Bill\\_Amt$",
    
    "$Max\\_Pmt\\_Amt$",
    
    "$Max\\_Dlq$",
    
    "$Age\\_21\\_25$"
    
    # "$ppk$",
    
   # "$ppkwoe$"
    
    
    
  ),
  Calculation = c(' $\\frac{PAY\\_AMT1}{BILL\\_AMT2}$',
                  # ' $\\frac{PAY\\_AMT2}{BILL\\_AMT3}$',
                  # ' $\\frac{PAY\\_AMT3}{BILL\\_AMT4}$',
                  # ' $\\frac{PAY\\_AMT4}{BILL\\_AMT5}$',
                  # ' $\\frac{PAY\\_AMT5}{BILL\\_AMT6}$',
  
                  ' $\\frac{\\sum_{Month=1}^{5}PAY\\_AMT_{Month}}{\\sum_{Month=2}^{6}BILL\\_AMT_{Month}}$',
                  
                  ' $\\frac{BILL\\_AMT1}{LIMIT\\_BAL}$',
                  # ' $\\frac{BILL\\_AMT2}{LIMIT\\_BAL}$',
                  # ' $\\frac{BILL\\_AMT3}{LIMIT\\_BAL}$',
                  # ' $\\frac{BILL\\_AMT4}{LIMIT\\_BAL}$',
                  # ' $\\frac{BILL\\_AMT5}{LIMIT\\_BAL}$',
                  # ' $\\frac{BILL\\_AMT6}{LIMIT\\_BAL}$',
                  
                  '$UTIL\\_5 - UTIL\\_6$',
                  # '$UTIL\\_4 - UTIL\\_5$',
                  # '$UTIL\\_3 - UTIL\\_4$',
                  # '$UTIL\\_2 - UTIL\\_3$',
                  # '$UTIL\\_1 - UTIL\\_2$',
                  
                  'mean(UTIL1,UTIL2,UTIL3,UTIL4,UTIL6)',
                  
                  'mean(BILL\\_AMT1,BILL\\_AMT2,BILL\\_AMT3,BILL\\_AMT4,BILL\\_AMT6)',
                  
                  '$BILL\\_AMT5 - BILL\\_AMT6$',
                  # '$BILL\\_AMT4 - BILL\\_AMT5$',
                  # '$BILL\\_AMT3 - BILL\\_AMT4$',
                  # '$BILL\\_AMT2 - BILL\\_AMT3$',
                  # '$BILL\\_AMT1 - BILL\\_AMT2$',
                  
                  '$mean(PAY\\_AMT1,PAY\\_AMT2,PAY\\_AMT3,PAY\\_AMT4,PAY\\_AMT6)$',
                  
                  
                  '$PAY\\_AMT5 - PAY\\_AMT6$',
                  # '$PAY\\_AMT4 - PAY\\_AMT5$',
                  # '$PAY\\_AMT3 - PAY\\_AMT4$',
                  # '$PAY\\_AMT2 - PAY\\_AMT3$',
                  # '$PAY\\_AMT1 - PAY\\_AMT2$',
                  
                  "$BILL\\_AMT1 - BILL\\_AMT6$",
                  
                  "$UTIL\\_1 - UTIL\\_6$",
                  
                  "$PMT\\_RATIO5 - PMT\\_RATIO6$",
                  # "$PMT\\_RATIO4 - PMT\\_RATIO5$",
                  # "$PMT\\_RATIO3 - PMT\\_RATIO4$",
                  # "$PMT\\_RATIO2 - PMT\\_RATIO3$",
                  
                  "$\\forall {UTILMR5,UTILMR4,UTILMR3,UTILMR2,UTILMR1} > 0$",
                  
                  "$\\forall {BILLAMTMR5,BILLAMTMR4,BILLAMTMR3,BILLAMTMR2,BILLAMTMR1} > 0$",
                  
                  "$\\forall{PAYMR5,PAYMR4,PAYMR3,PAYMR2,PAYMR1} > 0$",
                  
                  "$\\forall{PMT\\_RATIOMR5,PMT\\_RATIOMR4,PMT\\_RATIOMR3,PMT\\_RATIOMR2} > 0$",
                  
                  '$max(BILL\\_AMT1,BILL\\_AMT2,BILL\\_AMT3,BILL\\_AMT4,BILL\\_AMT6)$',
                  
                  '$max(PAY\\_AMT1,PAY\\_AMT2,PAY\\_AMT3,PAY\\_AMT4,PAY\\_AMT6)$',
                  
                  '$max(PAY\\_1,PAY\\_2,PAY\\_3,PAY\\_4,PAY\\_5,PAY\\_6)$',
                  
                  '$if AGE>=21 AND AGE<=25 then 1 else 0$'
                  
              # '$\\frac{(LIMIT\\_BAL - \\overline{BILL\\_AMT_{mth}})}{\\sqrt{\\sum_{mth=1}^6\\frac{(BILL\\_AMT_{mth} - \\overline{BILL\\_AMT_{mth}})^2}{5}}}$',
                  
                 # '$ppk binned & replaced by WOE$'
                  
                  
                  
                  
                  
                  
  )
  


)

knitr::kable(EngFeats,"latex", escape = F,booktabs = T) %>% 
  kable_styling(full_width = F,font_size = 7) %>% 
  column_spec(3,width = "15em")

```



```{r,eval=T}

# ------------------------------------------------------------
# PAY RATIO defined as payment over bill 
# Make the PAY_RATIO as 1 when the buill and pay amounts are 0
#-------------------------------------------------------------
creditdata %<>% 
  mutate(PMT_RATIO2 = ifelse(PAY_AMT1==0 & BILL_AMT2==0|BILL_AMT2 <= 0,1,PAY_AMT1/BILL_AMT2),
         PMT_RATIO3 = ifelse(PAY_AMT2==0 & BILL_AMT3== 0|BILL_AMT3 <= 0,1,PAY_AMT2/BILL_AMT3),
         PMT_RATIO4 = ifelse(PAY_AMT3==0 & BILL_AMT4==0|BILL_AMT4 <= 0,1,PAY_AMT3/BILL_AMT4),
         PMT_RATIO5 = ifelse(PAY_AMT4==0 & BILL_AMT5==0|BILL_AMT5 <= 0,1,PAY_AMT4/BILL_AMT5),
         PMT_RATIO6 = ifelse(PAY_AMT5==0 & BILL_AMT6==0|BILL_AMT6 <= 0,1,PAY_AMT5/BILL_AMT6)) %>% 
  mutate(
         Avg_PMT_RATIO = ifelse(rowSums(select(.,matches("BILL_AMT[2-6]")))==0,1,rowSums(select(.,matches("PAY_AMT[1-5]")))/rowSums(select(.,matches("BILL_AMT[2-6]")))))


```

2. Utilization of Credit limit

```{r,eval=T}
library(matrixStats)

# Utilization defined as a % usage of credit limit. When there is a negative bill the util is made 0.

creditdata %<>% 
  mutate(UTIL_1 = ifelse(BILL_AMT1/LIMIT_BAL < 0 , 0 , BILL_AMT1/LIMIT_BAL),
         UTIL_2 = ifelse(BILL_AMT2/LIMIT_BAL < 0 , 0 , BILL_AMT2/LIMIT_BAL),
         UTIL_3 = ifelse(BILL_AMT3/LIMIT_BAL < 0 , 0 , BILL_AMT3/LIMIT_BAL),
         UTIL_4 = ifelse(BILL_AMT4/LIMIT_BAL < 0 , 0 , BILL_AMT4/LIMIT_BAL),
         UTIL_5 = ifelse(BILL_AMT5/LIMIT_BAL < 0 , 0 , BILL_AMT5/LIMIT_BAL),
         UTIL_6 = ifelse(BILL_AMT6/LIMIT_BAL < 0 , 0 , BILL_AMT6/LIMIT_BAL))
```

```{r, eval = F}
# notice the utilization of the population is increasing over time?
# creditdata %>% select(starts_with("UTIL")) %>% skimr::skim()

# balance increasing?
# creditdata %>% select(starts_with("PAY_RAT")) %>% skimr::skim()

# creditdata %>% select(starts_with("BILL_AMT")) %>% skimr::skim()

```

3. Average Bill and Payment amounts

4. Velocity of Bill amount increase, payment amount decrease, utilization increase, pay ratio decrease.

```{r,eval=T}
#--------------------------------------------------------------------------------------------------------------
# While we that the median balance increases over time, how much of the population is causing this to increase
# Calculate the difference between subsequent months in UTIL and BIll_AMTs
#--------------------------------------------------------------------------------------------------------------

creditdata %<>% 
  mutate(Avg_UTIL = rowMeans(select(.,starts_with("UTIL"))),
         UTILMR5 = UTIL_5 - UTIL_6,
         UTILMR4 = UTIL_4 - UTIL_5,
         UTILMR3 = UTIL_3 - UTIL_4,
         UTILMR2 = UTIL_2 - UTIL_3,
         UTILMR1 = UTIL_1 - UTIL_2,
         Avg_BILL_Amt = rowMeans(select(.,starts_with("BILL_AMT")),na.rm = T),
         stdBILL = ifelse(rowSds(select(.,starts_with("BILL_AMT")) %>% as.matrix()) == 0, 0.01,rowSds(select(.,starts_with("BILL_AMT")) %>% as.matrix()))) %>% 
  mutate(ppk = (LIMIT_BAL - Avg_BILL_Amt)/(3*stdBILL),
         BILLAMTMR5 = BILL_AMT5 - BILL_AMT6,
         BILLAMTMR4 = BILL_AMT4 - BILL_AMT5,
         BILLAMTMR3 = BILL_AMT3 - BILL_AMT4,
         BILLAMTMR2 = BILL_AMT2 - BILL_AMT3,
         BILLAMTMR1 = BILL_AMT1 - BILL_AMT2,
         Avg_PMT_Amt = rowMeans(select(.,starts_with("PAY_AMT")),na.rm = T))


creditdata %<>%
  mutate(PAYMR5 = PAY_AMT5 - PAY_AMT6,
         PAYMR4 = PAY_AMT4 - PAY_AMT5,
         PAYMR3 = PAY_AMT3 - PAY_AMT4,
         PAYMR2 = PAY_AMT2 - PAY_AMT3,
         PAYMR1 = PAY_AMT1 - PAY_AMT2)

creditdata %<>% 
  mutate(Bal_Growth_6mo = BILL_AMT1 - BILL_AMT6,
         UTIL_Growth_6mo = UTIL_1 - UTIL_6,
         PMT_RATIOMR5 = PMT_RATIO5 - PMT_RATIO6,
         PMT_RATIOMR4 = PMT_RATIO4 - PMT_RATIO5,
         PMT_RATIOMR3 = PMT_RATIO3 - PMT_RATIO4,
         PMT_RATIOMR2 = PMT_RATIO2 - PMT_RATIO3
         )


  

# Customers with increasing utilization over time
creditdata %>% filter_at(vars(starts_with("UTILM")),all_vars(. > 0)) %>% select(ID) ->IDs

# customers with increasing Balance over time
creditdata %>% filter_at(vars(starts_with("BILLAMTMR")),all_vars(. > 0)) %>% select(ID) ->BalIDs

# customers with decreasing payments over time

creditdata %>% filter_at(vars(starts_with("PAYMR")),all_vars(. < 0)) %>% select(ID) ->payIDs

# customers with decreasing payment ratio over time

creditdata %>% filter_at(vars(starts_with("PMT_RATIOMR")),all_vars(. < 0)) %>% select(ID) ->payRatioIDs

creditdata %<>% 
  mutate(utilFlag = ifelse(ID %in% IDs$ID,1,0))

creditdata %<>% 
  mutate(balFlag = ifelse(ID %in% BalIDs$ID,1,0))

creditdata %<>% 
  mutate(payFlag = ifelse(ID %in% payIDs$ID,1,0))

creditdata %<>% 
  mutate(payRatioFlag = ifelse(ID %in% payRatioIDs$ID,1,0))


table(creditdata$DEFAULT,creditdata$utilFlag)

chisq.test(table(creditdata$DEFAULT,creditdata$utilFlag))


table(creditdata$DEFAULT,creditdata$balFlag)

chisq.test(table(creditdata$DEFAULT,creditdata$balFlag))

table(creditdata$DEFAULT,creditdata$payFlag)

chisq.test(table(creditdata$DEFAULT,creditdata$payFlag))


## Get percentage increase between month 6 and month 1

creditdata %<>%
  mutate(PerBALinc = (BILL_AMT6 - BILL_AMT1)/BILL_AMT6,
         PerUTILinc = (UTIL_6 - UTIL_1)/UTIL_6
         )

```

5. Max Bill and Payments 

```{r,eval=T}
creditdata %<>% 
  mutate(Max_Bill_Amt = rowMaxs(select(.,matches("BILL_AMT[0-9]")) %>% as.matrix()),
         Max_Pmt_Amt = rowMaxs(select(.,matches("PAY_AMT[0-9]")) %>% as.matrix()))
```


```{r,eval=T}

# Customers delinquent often
creditdata %<>%
  mutate(Max_Dlq = ifelse(rowMaxs(select(.,matches("PAY_[0-9]")) %>% as.matrix()) < 0,0,rowMaxs(select(.,matches("PAY_[0-9]")) %>% as.matrix()) ))

creditdata %>% 
  select(ID,matches("PAY_[0-9]")) %>% 
  gather(key = "Period", value = "DLQ",-ID) %>% 
  mutate(DLQ = ifelse(DLQ < 0, 0,DLQ)) %>% 
  group_by(ID) %>% 
  summarise(DLQs = count(DLQ > 0),
            DLQ_Total = sum(DLQ),
            DLQ_Max = max(DLQ)) -> Delequencies

creditdata %<>% 
  left_join(Delequencies)


  
```
6. Age Bucketing

```{r,eval=T}
# creditdata %<>% 
#   mutate(AgeBins = cut(AGE,breaks = seq(from = 25, to = 80,by = 5)))
#   
# Information::create_infotables(data = creditdata %>% select(AGE, DEFAULT) %>% mutate(DEFAULT = as.numeric(DEFAULT)-1), y = "DEFAULT", parallel = T, bins = 7) -> tst7
# 
# Information::plot_infotables(tst7,"AGE")

Information::create_infotables(data = creditdata %>% select(AGE, DEFAULT) %>% mutate(DEFAULT = as.numeric(DEFAULT)-1), y = "DEFAULT", parallel = T, bins = 6) -> tst6

Information::plot_infotables(tst6,"AGE")


# Information::create_infotables(data = creditdata %>% select(AGE, DEFAULT) %>% mutate(DEFAULT = as.numeric(DEFAULT)-1), y = "DEFAULT", parallel = T, bins = 5) -> tst5
# 
# Information::plot_infotables(tst5,"AGE")
# 
# Information::create_infotables(data = creditdata %>% select(AGE, DEFAULT) %>% mutate(DEFAULT = as.numeric(DEFAULT)-1), y = "DEFAULT", parallel = T, bins = 4) -> tst4
# 
# Information::plot_infotables(tst4,"AGE")

Information::create_infotables(data = creditdata %>% select(ppk, DEFAULT) %>% mutate(DEFAULT = as.numeric(DEFAULT)-1), y = "DEFAULT", parallel = T, bins = 5) -> tst5ppk

Information::plot_infotables(tst5ppk,"ppk")

```


```{r,eval=T}
library(OneR)

OneR::optbin(as.factor(DEFAULT) ~ AGE, data = creditdata, method = "infogain")-> optbin

plot(optbin)

```


```{r,eval=T}
tst6$Tables$AGE$AGE

creditdata %<>% 
  mutate(AGE_21_25 = ifelse(AGE>=21 & AGE<=25,1,0),
         AGE_26_29 = ifelse(AGE>=26 & AGE<=29,1,0),
         AGE_30_33 = ifelse(AGE>=30 & AGE<=33,1,0),
         AGE_34_38 = ifelse(AGE>=34 & AGE<=38,1,0),
         AGE_39_44 = ifelse(AGE>=39 & AGE<=44,1,0))

creditdata %<>% 
  mutate(ppkwoe = ifelse(ppk<0.49,0.30368328,
                         ifelse(ppk < 1.82,-0.06824883,
                                ifelse(ppk < 6.98,-0.08848357,
                                       ifelse(ppk < 27.3,-0.29885247,0.09571116)))))

```

##
## Feature Selection



```{r, eval = F}
creditdata %>% 
  filter(train == 1) %>% 
  select(-train,-test,-validate,-u,-data.group,-ID) -> trainData

ctrl <- trainControl(method = "cv",
                     summaryFunction = twoClassSummary,
                     classProbs = TRUE)
x = trainData %>% select(-DEFAULT)
y = as.factor(creditdata$DEFAULT[creditdata$train==1])
levels(y) <- c("no","yes")
rpartFit <- train(x = x, 
                  y = y,
                  method = "rpart",
                  tuneLength = 10,
                  metric = "ROC",
                  trControl = ctrl)

plot(rpartFit)



library(doParallel)
cl <- makePSOCKcluster(5)
registerDoParallel(cl)

rfFit <- train(x = x %>% select(-ppk,-PerBALinc,-PerUTILinc) %>% as.matrix(), 
                  y = y,
                  method = "rf",
                  tuneLength = 10,
                  metric = "ROC",
                  trControl = ctrl,
                  )

stopCluster(cl)

plot(rfFit)
plot(varImp(rfFit))

#skimr::skim(x)
```



